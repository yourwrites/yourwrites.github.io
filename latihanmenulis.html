<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Writing Practice</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #121212;
        color: #ffffff;
      }
      .form-control,
      .form-select {
        background-color: #1f1f1f;
        color: #ffffff;
        border: 1px solid #444;
      }
      .form-control:focus,
      .form-select:focus {
        background-color: #2a2a2a;
        color: #ffffff;
      }
      .bg-content {
        /* Diubah dari .bg-white menjadi .bg-content */
        background-color: #2a2a2a !important;
        color: #ffffff;
      }
      /* GAYA BARU UNTUK KOREKSI */
      .highlight-container {
        border: 1px solid #444;
        padding: 15px;
        border-radius: 8px;
        background-color: #1f1f1f;
        margin-top: 15px;
        margin-bottom: 20px;
        white-space: pre-wrap; /* Mempertahankan format spasi dan baris */
      }
      .highlight-error-text {
        color: #ff4d4f; /* Warna merah cerah untuk kesalahan */
        font-weight: bold;
      }
      .highlight-suggestion {
        color: #52c41a; /* Warna hijau cerah untuk saran */
        font-weight: bold;
      }
      .error-context mark {
        background-color: #ff4d4f70; /* Highlight merah transparan */
        color: white;
        padding: 0 3px;
        border-radius: 2px;
      }
      .error-detail {
        border-left: 3px solid #0d6efd;
        padding-left: 10px;
        margin-bottom: 15px;
        background-color: #2a2a2a;
        padding: 10px;
        border-radius: 4px;
      }
    </style>
    <script>
      const user = JSON.parse(localStorage.getItem("loggedInUser"));

      if (!user) {
        alert("Anda harus login untuk mengakses halaman ini.");
        window.location.href = "login.html";
      }

      // Menambahkan cek peran guru seperti yang ada di file original Anda, jika ada
      if (user && user.role === "guru") {
        // Asumsi: jika ada properti role atau menggunakan email khusus
        // Saya asumsikan role siswanya tidak disimpan, jadi hanya cek guru jika ada
      }

      document.addEventListener("DOMContentLoaded", () => {
        if (user) {
          const namaSiswaInput = document.getElementById("namaSiswa");
          // Mengisi nama siswa secara otomatis dan menonaktifkan inputnya
          namaSiswaInput.value = user.nama;
          namaSiswaInput.setAttribute("disabled", "true");
        }
        tampilkanPanduan();
      });
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-dark" data-bs-theme="dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="user_siswa.html">
          <img
            src="/aset gambar gitu brek/logoYOUr WRITES.png"
            alt="..."
            width="40"
            class="ml-3"
          />
        </a>
        <a class="navbar-brand h1" href="#">YOUr WRITEs</a>
        <div class="ms-auto">
          <a href="user_siswa.html" class="btn btn-outline-info"
            >Kembali ke Dashboard</a
          >
        </div>
      </div>
    </nav>
    <div class="container py-5">
      <h2 class="mb-4">Practice Your Writing</h2>

      <form id="formLatihan">
        <div class="mb-3">
          <label for="jenisTeks" class="form-label">Choose Type of Text:</label>
          <select
            id="jenisTeks"
            name="jenis"
            class="form-select"
            onchange="tampilkanPanduan()"
            required
          >
            <option value="" disabled selected>Select...</option>
            <option value="Descriptive">Descriptive Text</option>
            <option value="Narrative">Narrative Text</option>
            <option value="Explanatory">Explanatory Text</option>
            <option value="Recount">Recount Text</option>
            <option value="Procedure">Procedure Text</option>
            <option value="Exposition">Exposition Text</option>
          </select>
        </div>

        <div class="mb-3">
          <h5>Example</h5>
          <div id="panduanTeks" class="p-3 border rounded bg-content"></div>
        </div>

        <div class="mb-3">
          <label for="namaSiswa" class="form-label">Your Name (Auto):</label>
          <input
            type="text"
            id="namaSiswa"
            name="nama"
            class="form-control"
            disabled
            required
          />
        </div>

        <div class="mb-3">
          <label for="jawaban" class="form-label">Write Your Text:</label>
          <textarea
            id="jawaban"
            name="teks"
            class="form-control"
            rows="8"
            required
          ></textarea>
        </div>

        <button type="submit" class="btn btn-success">Save</button>
        <button
          type="button"
          class="btn btn-warning ms-2"
          onclick="koreksiOtomatis(this)"
        >
          <span id="checkText">Grammar Check</span>
        </button>
      </form>

      <div class="mt-4">
        <h5 class="text-info">Teks Anda Setelah Diperiksa:</h5>
        <div id="highlightedText" class="highlight-container">
          <p class="text-secondary mb-0">
            Tekan "Grammar Check" untuk melihat hasilnya.
          </p>
        </div>
      </div>

      <div class="mt-4" id="hasilKoreksi"></div>
    </div>

    <script>
      const panduan = {
        Descriptive: `<strong>Descriptive Text</strong><br>Describe people, animals, or places.<br><em>Example:</em> My cat is very cute. It has white fur and blue eyes.`,
        Narrative: `<strong>Narrative Text</strong><br>Tells a fictional or real story.<br><em>Example:</em> Once upon a time, there lived a girl named Cinderella...`,
        Explanatory: `<strong>Explanatory Text</strong><br>Explains a process or phenomenon.<br><em>Example:</em> The water cycle consists of evaporation, condensation, and precipitation.`,
        Recount: `<strong>Recount Text</strong><br>Tells past experiences.<br><em>Example:</em> Last holiday, I went to Bandung with my family...`,
        Procedure: `<strong>Procedure Text</strong><br>Gives instructions or steps.<br><em>Example:</em> How to make a cup of tea: First, boil water...`,
        Exposition: `<strong>Exposition Text</strong><br>Presents opinion or argument.<br><em>Example:</em> I believe online learning is beneficial because...`,
      };

      function tampilkanPanduan() {
        const jenis = document.getElementById("jenisTeks").value;
        document.getElementById("panduanTeks").innerHTML =
          panduan[jenis] || "Pilih jenis teks untuk melihat panduan.";
      }

      function formatErrorContext(text, offset, length, errorIndex) {
        // Fungsi untuk memasukkan tag <mark> di sekitar kesalahan
        // Kami menggunakan index kesalahan untuk memastikan tag <mark> unik jika diperlukan,
        // tapi di sini cukup menggunakan tag mark biasa
        const before = text.substring(0, offset);
        const error = text.substring(offset, offset + length);
        const after = text.substring(offset + length);
        return `${before}<mark>${error}</mark>${after}`;
      }

      async function koreksiOtomatis(button) {
        const teks = document.getElementById("jawaban").value; // Ambil teks asli termasuk baris baru
        const hasilKoreksiDiv = document.getElementById("hasilKoreksi");
        const highlightedTextDiv = document.getElementById("highlightedText");
        const originalButtonText = button.querySelector("#checkText");

        if (!teks.trim()) {
          hasilKoreksiDiv.innerHTML = `<div class="alert alert-danger" role="alert">Tolong tuliskan teks terlebih dahulu!</div>`;
          highlightedTextDiv.innerHTML = `<p class="text-secondary mb-0">Tekan "Grammar Check" untuk melihat hasilnya.</p>`;
          return;
        }

        originalButtonText.textContent = "Checking...";
        button.disabled = true;
        hasilKoreksiDiv.innerHTML = `<div class="text-warning mt-3">Sedang mengecek tata bahasa, harap tunggu...</div>`;
        highlightedTextDiv.innerHTML = `<p class="text-warning mb-0">Memproses teks...</p>`;

        try {
          // Menggunakan LanguageTool API
          const response = await fetch(
            "https://api.languagetool.org/v2/check",
            {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({
                text: teks,
                language: "en-US",
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`API returned status ${response.status}`);
          }

          const result = await response.json();
          const matches = result.matches;

          let feedbackHTML = `<h5>Hasil Pengecekan Tata Bahasa (${matches.length} Kesalahan Ditemukan)</h5>`;
          let markedText = teks;

          if (matches.length === 0) {
            feedbackHTML += `<div class="alert alert-success" role="alert">üéâ Tidak ada kesalahan tata bahasa ditemukan! Tulisanmu sudah bagus.</div>`;
            highlightedTextDiv.innerHTML = `<p>${teks}</p>`;
          } else {
            // 1. BUAT TEKS YANG DI-HIGHLIGHT (Revisi dari belakang agar offset tidak berubah)
            // Clone matches dan urutkan berdasarkan offset DESC
            const sortedMatches = [...matches].sort(
              (a, b) => b.context.offset - a.context.offset
            );

            sortedMatches.forEach((match, i) => {
              markedText = formatErrorContext(
                markedText,
                match.context.offset,
                match.context.length,
                i
              );
            });

            // Tampilkan teks yang sudah di-highlight
            highlightedTextDiv.innerHTML = `<p class="error-context">${markedText}</p>`;

            // 2. BUAT DETAIL UMPAN BALIK
            feedbackHTML += `<div class="mt-3">`;

            matches.forEach((match, i) => {
              const contextText = teks.substring(
                match.context.offset,
                match.context.offset + match.context.length
              );

              // Ambil maksimal 3 saran
              const suggestions =
                match.replacements
                  .map(
                    (r) =>
                      `<span class="highlight-suggestion">${r.value}</span>`
                  )
                  .slice(0, 3)
                  .join(", ") || "Tidak ada saran perbaikan";

              // Gunakan deskripsi aturan jika pesan utama kurang jelas
              const ruleCategory = match.rule.category.name || "Koreksi Umum";

              feedbackHTML += `
                <div class="error-detail">
                  <p class="mb-1 fw-bold text-danger">#${
                    i + 1
                  }. ${ruleCategory}</p>
                  <p class="mb-1"><strong>Kesalahan:</strong> Terdapat kata/frasa <span class="highlight-error-text">"${contextText}"</span>.</p>
                  <p class="mb-1"><strong>Penjelasan:</strong> ${
                    match.message
                  }.</p>
                  <p class="mb-0"><strong>Saran Perbaikan:</strong> ${suggestions}</p>
                </div>
              `;
            });
            feedbackHTML += `</div>`;
          }

          hasilKoreksiDiv.innerHTML = feedbackHTML;
        } catch (error) {
          hasilKoreksiDiv.innerHTML = `<div class="alert alert-danger" role="alert">‚ùå Gagal melakukan pemeriksaan: ${error.message}. Pastikan koneksi internet stabil.</div>`;
          highlightedTextDiv.innerHTML = `<p class="text-danger mb-0">Pengecekan gagal.</p>`;
        } finally {
          originalButtonText.textContent = "Grammar Check";
          button.disabled = false;
        }
      }

      // Handler untuk form submit (Tombol Save)
      document
        .getElementById("formLatihan")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const jenis = document.getElementById("jenisTeks").value;
          const teks = document.getElementById("jawaban").value;

          const userName = user ? user.nama : "Anonim";

          const tulisanBaru = {
            nama: userName,
            jenis,
            teks,
            tanggal: new Date().toLocaleString(),
          };

          let semuaTulisan = JSON.parse(
            localStorage.getItem("semuaTulisan") || "[]"
          );

          semuaTulisan.push(tulisanBaru);

          localStorage.setItem("semuaTulisan", JSON.stringify(semuaTulisan));

          document.getElementById("formLatihan").reset();
          document.getElementById("panduanTeks").innerHTML = "";
          document.getElementById("hasilKoreksi").innerHTML = "";
          document.getElementById(
            "highlightedText"
          ).innerHTML = `<p class="text-secondary mb-0">Tekan "Grammar Check" untuk melihat hasilnya.</p>`;

          // Set nama otomatis lagi setelah reset
          if (user) {
            document.getElementById("namaSiswa").value = user.nama;
          }

          alert(
            "Tulisan berhasil disimpan. Kembali ke halaman utama untuk melihatnya!"
          );
        });

      document.addEventListener("DOMContentLoaded", tampilkanPanduan);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
